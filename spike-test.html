<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File System Access API - Spike Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 40px;
            background: #f5f5f5;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .status {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .status.info { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e9; color: #388e3c; }
        .status.error { background: #ffebee; color: #d32f2f; }
        .status.warning { background: #fff3e0; color: #f57c00; }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }

        .test-section h2 {
            color: #555;
            margin-bottom: 15px;
            font-size: 18px;
        }

        button {
            background: #07c160;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #06ad56;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }

        .log-entry.success { color: #388e3c; }
        .log-entry.error { color: #d32f2f; }
        .log-entry.info { color: #1976d2; }

        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .metric {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            border-left: 3px solid #07c160;
        }

        .metric-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª File System Access API - æŠ€æœ¯éªŒè¯</h1>
        <div id="browserSupport" class="status info">æ£€æµ‹ä¸­...</div>

        <!-- Test 1: DirectoryHandle æŒä¹…åŒ– -->
        <div class="test-section">
            <h2>Test 1: DirectoryHandle æŒä¹…åŒ–ä¸æƒé™æ¢å¤</h2>
            <button id="selectDir">é€‰æ‹©æ–‡ä»¶å¤¹</button>
            <button id="restoreDir">æ¢å¤æ–‡ä»¶å¤¹</button>
            <button id="checkPermission">æ£€æŸ¥æƒé™</button>
            <button id="requestPermission">è¯·æ±‚æƒé™</button>
            <div id="handleLog" class="log"></div>
        </div>

        <!-- Test 2: æ–‡ä»¶ CRUD æ“ä½œ -->
        <div class="test-section">
            <h2>Test 2: æ–‡ä»¶ CRUD æ“ä½œ</h2>
            <button id="createFile">åˆ›å»ºæ–‡ä»¶</button>
            <button id="readFile">è¯»å–æ–‡ä»¶</button>
            <button id="updateFile">æ›´æ–°æ–‡ä»¶</button>
            <button id="deleteFile">åˆ é™¤æ–‡ä»¶</button>
            <button id="listFiles">åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶</button>
            <div id="crudLog" class="log"></div>
        </div>

        <!-- Test 3: æ€§èƒ½æµ‹è¯• -->
        <div class="test-section">
            <h2>Test 3: æ€§èƒ½æµ‹è¯•</h2>
            <button id="perfTest">è¿è¡Œæ€§èƒ½æµ‹è¯•</button>
            <button id="clearTestFiles">æ¸…ç†æµ‹è¯•æ–‡ä»¶</button>
            <div class="metrics" id="metrics"></div>
            <div id="perfLog" class="log"></div>
        </div>

        <!-- Test 4: æ•°æ®è¿ç§»æ¨¡æ‹Ÿ -->
        <div class="test-section">
            <h2>Test 4: æ•°æ®è¿ç§»æ¨¡æ‹Ÿ</h2>
            <button id="simulateMigration">æ¨¡æ‹Ÿä» IndexedDB è¿ç§»</button>
            <div id="migrationLog" class="log"></div>
        </div>
    </div>

    <script type="module">
        // ========== å·¥å…·å‡½æ•° ==========
        let lastFileName = null;
        function log(elementId, message, type = 'info') {
            const logEl = document.getElementById(elementId);
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function showMetric(label, value, unit = '') {
            const metricsEl = document.getElementById('metrics');
            const metric = document.createElement('div');
            metric.className = 'metric';
            metric.innerHTML = `
                <div class="metric-label">${label}</div>
                <div class="metric-value">${value}${unit}</div>
            `;
            metricsEl.appendChild(metric);
        }

        // ========== æµè§ˆå™¨æ”¯æŒæ£€æµ‹ ==========
        const isSupported = 'showDirectoryPicker' in window;
        const supportEl = document.getElementById('browserSupport');
        
        if (isSupported) {
            supportEl.className = 'status success';
            supportEl.textContent = 'âœ… æµè§ˆå™¨æ”¯æŒ File System Access API';
        } else {
            supportEl.className = 'status error';
            supportEl.textContent = 'âŒ æµè§ˆå™¨ä¸æ”¯æŒ File System Access APIï¼ˆéœ€è¦ Chrome 86+ æˆ– Edge 86+ï¼‰';
        }

        // ========== IndexedDB å·¥å…· ==========
        let db;
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('wemd-spike-test', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('handles')) {
                        db.createObjectStore('handles');
                    }
                };
            });
        }

        async function saveHandle(key, handle) {
            const tx = db.transaction('handles', 'readwrite');
            const store = tx.objectStore('handles');
            await store.put(handle, key);
            await tx.complete;
        }

        async function getHandle(key) {
            const tx = db.transaction('handles', 'readonly');
            const store = tx.objectStore('handles');
            return new Promise((resolve, reject) => {
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }

        // ========== å…¨å±€çŠ¶æ€ ==========
        let dirHandle = null;

        // ========== Test 1: DirectoryHandle æŒä¹…åŒ– ==========
        document.getElementById('selectDir').addEventListener('click', async () => {
            try {
                await initDB();
                dirHandle = await window.showDirectoryPicker({ mode: 'readwrite' });
                await saveHandle('workspace', dirHandle);
                log('handleLog', `âœ… å·²é€‰æ‹©æ–‡ä»¶å¤¹: ${dirHandle.name}`, 'success');
                log('handleLog', 'âœ… Handle å·²ä¿å­˜åˆ° IndexedDB', 'success');
            } catch (error) {
                log('handleLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        document.getElementById('restoreDir').addEventListener('click', async () => {
            try {
                await initDB();
                dirHandle = await getHandle('workspace');
                if (dirHandle) {
                    log('handleLog', `âœ… å·²ä» IndexedDB æ¢å¤ Handle: ${dirHandle.name}`, 'success');
                } else {
                    log('handleLog', 'âš ï¸ æœªæ‰¾åˆ°ä¿å­˜çš„ Handle', 'warning');
                }
            } catch (error) {
                log('handleLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        document.getElementById('checkPermission').addEventListener('click', async () => {
            if (!dirHandle) {
                log('handleLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æˆ–æ¢å¤æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            try {
                const permission = await dirHandle.queryPermission({ mode: 'readwrite' });
                log('handleLog', `ğŸ“‹ å½“å‰æƒé™çŠ¶æ€: ${permission}`, 'info');
            } catch (error) {
                log('handleLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        document.getElementById('requestPermission').addEventListener('click', async () => {
            if (!dirHandle) {
                log('handleLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æˆ–æ¢å¤æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            try {
                const permission = await dirHandle.requestPermission({ mode: 'readwrite' });
                log('handleLog', `âœ… æƒé™è¯·æ±‚ç»“æœ: ${permission}`, permission === 'granted' ? 'success' : 'error');
            } catch (error) {
                log('handleLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        // ========== Test 2: æ–‡ä»¶ CRUD æ“ä½œ ==========
        document.getElementById('createFile').addEventListener('click', async () => {
            if (!dirHandle) {
                log('crudLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            try {
                const fileName = `test-${Date.now()}.md`;
                const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                const writable = await fileHandle.createWritable();
                await writable.write(`# æµ‹è¯•æ–‡ç« \n\nåˆ›å»ºæ—¶é—´: ${new Date().toLocaleString()}`);
                await writable.close();
                lastFileName = fileName;
                log('crudLog', `âœ… å·²åˆ›å»ºæ–‡ä»¶: ${fileName}`, 'success');
            } catch (error) {
                log('crudLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        document.getElementById('listFiles').addEventListener('click', async () => {
            if (!dirHandle) {
                log('crudLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            try {
                const files = [];
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file' && entry.name.endsWith('.md')) {
                        files.push(entry.name);
                    }
                }
                log('crudLog', `ğŸ“ æ‰¾åˆ° ${files.length} ä¸ª .md æ–‡ä»¶`, 'info');
                files.forEach(name => log('crudLog', `  - ${name}`, 'info'));
            } catch (error) {
                log('crudLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        document.getElementById('readFile').addEventListener('click', async () => {
            if (!dirHandle) {
                log('crudLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            if (!lastFileName) {
                log('crudLog', 'â„¹ï¸ è¿˜æ²¡æœ‰åˆ›å»ºè¿‡æ–‡ä»¶ï¼Œè¯·å…ˆç‚¹å‡»â€œåˆ›å»ºæ–‡ä»¶â€', 'info');
                return;
            }
            try {
                const fileHandle = await dirHandle.getFileHandle(lastFileName);
                const file = await fileHandle.getFile();
                const content = await file.text();
                log('crudLog', `ğŸ“– è¯»å– ${lastFileName} æˆåŠŸï¼Œå†…å®¹é¢„è§ˆ: ${content.slice(0, 60)}...`, 'success');
            } catch (error) {
                log('crudLog', `âŒ è¯»å–å¤±è´¥: ${error.message}`, 'error');
            }
        });

        document.getElementById('updateFile').addEventListener('click', async () => {
            if (!dirHandle) {
                log('crudLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            if (!lastFileName) {
                log('crudLog', 'â„¹ï¸ æ²¡æœ‰å¯æ›´æ–°çš„æ–‡ä»¶ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ª', 'info');
                return;
            }
            try {
                const fileHandle = await dirHandle.getFileHandle(lastFileName);
                const writable = await fileHandle.createWritable();
                await writable.write(`# æ›´æ–°åçš„å†…å®¹\n\næ›´æ–°æ—¶é—´: ${new Date().toLocaleString()}`);
                await writable.close();
                log('crudLog', `âœï¸ å·²æ›´æ–°æ–‡ä»¶: ${lastFileName}`, 'success');
            } catch (error) {
                log('crudLog', `âŒ æ›´æ–°å¤±è´¥: ${error.message}`, 'error');
            }
        });

        document.getElementById('deleteFile').addEventListener('click', async () => {
            if (!dirHandle) {
                log('crudLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            if (!lastFileName) {
                log('crudLog', 'â„¹ï¸ æ²¡æœ‰å¯åˆ é™¤çš„æ–‡ä»¶ï¼Œè¯·å…ˆåˆ›å»ºä¸€ä¸ª', 'info');
                return;
            }
            try {
                await dirHandle.removeEntry(lastFileName);
                log('crudLog', `ğŸ—‘ï¸ å·²åˆ é™¤æ–‡ä»¶: ${lastFileName}`, 'success');
                lastFileName = null;
            } catch (error) {
                log('crudLog', `âŒ åˆ é™¤å¤±è´¥: ${error.message}`, 'error');
            }
        });

        // ========== Test 3: æ€§èƒ½æµ‹è¯• ==========
        document.getElementById('perfTest').addEventListener('click', async () => {
            if (!dirHandle) {
                log('perfLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            
            document.getElementById('metrics').innerHTML = '';
            log('perfLog', 'ğŸš€ å¼€å§‹æ€§èƒ½æµ‹è¯•...', 'info');
            
            try {
                // æµ‹è¯• 1: å†™å…¥æ€§èƒ½
                const writeCount = 100;
                const writeStart = performance.now();
                for (let i = 0; i < writeCount; i++) {
                    const fileHandle = await dirHandle.getFileHandle(`perf-test-${i}.md`, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(`# Test ${i}\n\nContent here...`);
                    await writable.close();
                }
                const writeTime = performance.now() - writeStart;
                showMetric('å†™å…¥ 100 æ–‡ä»¶', writeTime.toFixed(0), 'ms');
                log('perfLog', `âœ… å†™å…¥æµ‹è¯•å®Œæˆ: ${writeTime.toFixed(0)}ms`, 'success');
                
                // æµ‹è¯• 2: åˆ—è¡¨æ€§èƒ½
                const listStart = performance.now();
                const files = [];
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file') files.push(entry);
                }
                const listTime = performance.now() - listStart;
                showMetric('åˆ—å‡ºæ–‡ä»¶', listTime.toFixed(0), 'ms');
                showMetric('æ–‡ä»¶æ€»æ•°', files.length, '');
                log('perfLog', `âœ… åˆ—è¡¨æµ‹è¯•å®Œæˆ: ${listTime.toFixed(0)}ms, ${files.length} ä¸ªæ–‡ä»¶`, 'success');
                
                // æµ‹è¯• 3: è¯»å–æ€§èƒ½
                const readStart = performance.now();
                for (let i = 0; i < Math.min(writeCount, files.length); i++) {
                    const entry = files[i];
                    if (entry.name.startsWith('perf-test-')) {
                        const file = await entry.getFile();
                        await file.text();
                    }
                }
                const readTime = performance.now() - readStart;
                showMetric('è¯»å– 100 æ–‡ä»¶', readTime.toFixed(0), 'ms');
                log('perfLog', `âœ… è¯»å–æµ‹è¯•å®Œæˆ: ${readTime.toFixed(0)}ms`, 'success');
                
                log('perfLog', 'ğŸ‰ æ€§èƒ½æµ‹è¯•å…¨éƒ¨å®Œæˆï¼', 'success');
            } catch (error) {
                log('perfLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        document.getElementById('clearTestFiles').addEventListener('click', async () => {
            if (!dirHandle) {
                log('perfLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            try {
                let count = 0;
                for await (const entry of dirHandle.values()) {
                    if (entry.kind === 'file' && entry.name.startsWith('perf-test-')) {
                        await dirHandle.removeEntry(entry.name);
                        count++;
                    }
                }
                log('perfLog', `âœ… å·²æ¸…ç† ${count} ä¸ªæµ‹è¯•æ–‡ä»¶`, 'success');
            } catch (error) {
                log('perfLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        // ========== Test 4: æ•°æ®è¿ç§»æ¨¡æ‹Ÿ ==========
        document.getElementById('simulateMigration').addEventListener('click', async () => {
            if (!dirHandle) {
                log('migrationLog', 'âš ï¸ è¯·å…ˆé€‰æ‹©æ–‡ä»¶å¤¹', 'warning');
                return;
            }
            
            try {
                log('migrationLog', 'ğŸ“¦ æ¨¡æ‹Ÿä» IndexedDB è¿ç§»æ•°æ®...', 'info');
                
                // æ¨¡æ‹Ÿçš„ IndexedDB æ•°æ®
                const mockData = [
                    { id: '1', title: 'æˆ‘çš„ç¬¬ä¸€ç¯‡æ–‡ç« ', content: '# æˆ‘çš„ç¬¬ä¸€ç¯‡æ–‡ç« \n\nè¿™æ˜¯å†…å®¹...' },
                    { id: '2', title: 'æŠ€æœ¯ç¬”è®°', content: '# æŠ€æœ¯ç¬”è®°\n\nå­¦ä¹ è®°å½•...' },
                    { id: '3', title: 'æ¯æ—¥æ€»ç»“', content: '# æ¯æ—¥æ€»ç»“\n\nä»Šå¤©å­¦åˆ°äº†...' }
                ];
                
                const startTime = performance.now();
                for (const item of mockData) {
                    const fileName = `${item.title}-${item.id}.md`;
                    const fileHandle = await dirHandle.getFileHandle(fileName, { create: true });
                    const writable = await fileHandle.createWritable();
                    await writable.write(item.content);
                    await writable.close();
                    log('migrationLog', `âœ… å·²è¿ç§»: ${fileName}`, 'success');
                }
                const elapsed = performance.now() - startTime;
                
                log('migrationLog', `ğŸ‰ è¿ç§»å®Œæˆï¼ç”¨æ—¶ ${elapsed.toFixed(0)}ms`, 'success');
            } catch (error) {
                log('migrationLog', `âŒ é”™è¯¯: ${error.message}`, 'error');
            }
        });

        // åˆå§‹åŒ–
        initDB().catch(console.error);
    </script>
</body>
</html>
