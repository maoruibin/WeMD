# 主题选择持久化 PRD

> **角色提示**：编写本文档时，请扮演 **产品经理** 角色
> 详细角色说明请查看：[docs/templates/roles/01-pm.md](../../../../../../templates/roles/01-pm.md)

---

## 📋 元信息

| 项目 | 内容 |
|------|------|
| **PRD 编号** | FEAT-003 |
| **编写日期** | 2025-01-14 |
| **负责人** | @gudong |
| **优先级** | P1 |
| **预期版本** | v1.3.0 |
| **当前状态** | 📝 待评审 |

---

## 🎯 背景与目标

### 用户痛点
- 用户选择喜欢的主题后，刷新页面或重新打开网页时，主题会重置为默认主题
- 每次打开都需要重新选择主题，影响用户体验
- 对于有特定主题偏好的用户（如经常使用某种风格发布内容的用户）尤其不便

### 目标用户
- 主要用户群体：所有 WeMD 用户，尤其是频繁使用编辑器的用户
- 使用场景：用户打开编辑器准备编写/编辑文章时

### 目标
- 保存用户的主题选择，下次打开时自动恢复
- 提升用户体验，减少重复操作

---

## 📖 功能描述

### 用户故事
```
**作为** WeMD 编辑器用户
**我想要** 我选择的主题能够被记住
**以便于** 下次打开编辑器时直接使用我喜欢的主题，无需重新选择
```

### 核心功能点
- [x] 选中主题后，立即保存到 localStorage
- [x] 页面加载时，从 localStorage 读取上次选择的主题
- [x] 如果保存的主题不存在（如被删除），自动回退到默认主题
- [x] 验证现有代码逻辑，找出持久化失效的根本原因

---

## 🎨 交互流程

### 正常流程
1. 用户打开编辑器
2. 系统检查 localStorage 中是否有保存的主题
3. 如果有且主题存在，自动选中该主题
4. 用户切换主题时，立即保存新选择

### 边界情况
- **保存的主题不存在**：回退到默认主题
- **localStorage 不可用**：使用默认主题（如隐私模式）
- **自定义主题被删除**：回退到默认主题
- **主题 ID 格式错误**：忽略错误数据，使用默认主题

### UI 草图
无 UI 变更，仅修复逻辑问题

---

## ✅ 验收标准

### 功能验收
- [ ] 选择主题后，刷新页面保持选中状态
- [ ] 关闭浏览器重新打开，保持选中状态
- [ ] 删除当前选中的自定义主题后，正确回退到默认主题
- [ ] localStorage 不可用时，正常使用默认主题

### 性能要求
- [ ] 主题读取/写入操作不阻塞页面渲染
- [ ] 页面加载时间不受影响

### 兼容性要求
- [ ] Chrome 最新版
- [ ] Safari 最新版
- [ ] 微信内置浏览器
- [ ] Firefox 最新版

### 非功能需求
- 确保不因 localStorage 写入失败导致功能异常
- 错误静默处理，不影响编辑器正常使用

---

## 🐛 问题分析

### 当前实现
代码中已有 `saveSelectedTheme` 和 `loadSelectedTheme` 函数，并在 `selectTheme` 时调用保存。

### 可能的问题点
1. **初始化时序**：`initialSelectedTheme` 在模块加载时执行，可能与 Zustand store 创建有冲突
2. **验证逻辑**：`allThemes.some((t) => t.id === saved.id)` 验证失败
3. **Store 状态覆盖**：后续操作可能覆盖了初始加载的主题

### 待确认
- 需要通过调试确认具体是哪个环节导致持久化失效

---

## 🔗 相关文档

- [UI 设计文档](../02-design/ui-design.md)
- [技术设计文档](../03-dev/tech-design.md)

---

## 📝 变更记录

| 日期 | 版本 | 变更内容 | 作者 |
|------|------|----------|------|
| 2025-01-14 | 1.0 | 初始版本 | @gudong |
