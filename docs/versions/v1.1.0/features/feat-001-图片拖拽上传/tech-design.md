# å›¾ç‰‡æ‹–æ‹½ä¸Šä¼  æŠ€æœ¯è®¾è®¡

## ğŸ“‹ å…ƒä¿¡æ¯

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **æ–‡æ¡£ç¼–å·** | TD-001 |
| **å…³è” PRD** | FEAT-001 |
| **ç¼–å†™æ—¥æœŸ** | 2024-01-13 |
| **è´Ÿè´£äºº** | @your-name |
| **å½“å‰çŠ¶æ€** | ğŸ“ è‰ç¨¿ |

---

## ğŸ¯ æ–¹æ¡ˆæ¦‚è¿°

### éœ€æ±‚å›é¡¾
- æ”¯æŒæ‹–æ‹½å›¾ç‰‡æ–‡ä»¶åˆ°ç¼–è¾‘å™¨è‡ªåŠ¨ä¸Šä¼ 
- æ”¯æŒç²˜è´´æˆªå›¾ç›´æ¥ä¸Šä¼ 
- æ”¯æŒæ‰¹é‡ä¸Šä¼ 
- ä¸Šä¼ è¿›åº¦å±•ç¤º
- é”™è¯¯å¤„ç†ä¸é‡è¯•

### è®¾è®¡ç›®æ ‡
- æ— ä¾µå…¥å¼é›†æˆåˆ°ç°æœ‰ç¼–è¾‘å™¨
- å¤ç”¨ç°æœ‰å›¾åºŠæœåŠ¡
- ä¿æŒç¼–è¾‘å™¨æ€§èƒ½ä¸å—å½±å“

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç”¨æˆ·æ“ä½œå±‚                           â”‚
â”‚  æ‹–æ‹½æ–‡ä»¶ / ç²˜è´´å‰ªè´´æ¿                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Dropzone ç»„ä»¶                           â”‚
â”‚  - dragover/drop äº‹ä»¶ç›‘å¬                               â”‚
â”‚  - paste äº‹ä»¶ç›‘å¬                                        â”‚
â”‚  - æ–‡ä»¶ç±»å‹éªŒè¯                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ImageUploadService (æ–°å»º)                   â”‚
â”‚  - é˜Ÿåˆ—ç®¡ç†                                              â”‚
â”‚  - è¿›åº¦è¿½è¸ª                                              â”‚
â”‚  - é”™è¯¯å¤„ç†                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç°æœ‰å›¾åºŠæœåŠ¡                                   â”‚
â”‚  - ImageUploadService (æœ¬åœ°)                            â”‚
â”‚  - R2WorkerService (Cloudflare R2)                      â”‚
â”‚  - QiniuService (ä¸ƒç‰›äº‘)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ç¼–è¾‘å™¨æ’å…¥                                  â”‚
â”‚  - æ’å…¥ Markdown å›¾ç‰‡è¯­æ³•                                â”‚
â”‚  - æ›´æ–°é¢„è§ˆ                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—åˆ’åˆ†

| æ¨¡å— | èŒè´£ | æ–‡ä»¶ä½ç½® |
|------|------|----------|
| Dropzone | æ‹–æ‹½åŒºåŸŸç»„ä»¶ï¼Œå¤„ç† drag/drop/paste äº‹ä»¶ | `components/Editor/Dropzone/` |
| UploadManager | ä¸Šä¼ é˜Ÿåˆ—å’Œè¿›åº¦ç®¡ç† | `components/Editor/UploadManager/` |
| imageUploadStore | ä¸Šä¼ çŠ¶æ€ç®¡ç† | `store/imageUploadStore.ts` |
| useImageUpload | ä¸Šä¼ é€»è¾‘ Hook | `hooks/useImageUpload.ts` |

---

## ğŸ“¦ æŠ€æœ¯é€‰å‹

### æ–°å¢ä¾èµ–
æ— éœ€æ–°å¢ä¾èµ–ï¼Œä½¿ç”¨ç°æœ‰æŠ€æœ¯æ ˆã€‚

### å¤ç”¨ç°æœ‰
- **lucide-react**: å›¾æ ‡
- **react-hot-toast**: ä¸Šä¼ æˆåŠŸ/å¤±è´¥æç¤º
- **zustand**: çŠ¶æ€ç®¡ç†
- **ç°æœ‰å›¾åºŠæœåŠ¡**: `apps/web/src/services/imageUpload/`

---

## ğŸ”„ æ•°æ®æµè®¾è®¡

```mermaid
graph TD
    A[ç”¨æˆ·æ‹–æ‹½å›¾ç‰‡] --> B{Dropzone ç›‘å¬}
    B --> C{æ–‡ä»¶ç±»å‹éªŒè¯}
    C -->|éå›¾ç‰‡| D[æ˜¾ç¤ºé”™è¯¯æç¤º]
    C -->|å›¾ç‰‡| E[UploadManager]
    E --> F[æ·»åŠ åˆ°ä¸Šä¼ é˜Ÿåˆ—]
    F --> G[è°ƒç”¨å›¾åºŠä¸Šä¼ ]
    G --> H{ä¸Šä¼ ç»“æœ}
    H -->|æˆåŠŸ| I[æ’å…¥ Markdown]
    H -->|å¤±è´¥| J[æ˜¾ç¤ºé‡è¯•é€‰é¡¹]
    I --> K[æ›´æ–°ç¼–è¾‘å™¨]
    J -->|ç”¨æˆ·é‡è¯•| G
    J -->|ç”¨æˆ·å–æ¶ˆ| L[ä»é˜Ÿåˆ—ç§»é™¤]
```

### Store å˜æ›´

**æ–°å»º Store**: `imageUploadStore.ts`

```typescript
interface UploadTask {
  id: string;
  file: File;
  progress: number;
  status: 'pending' | 'uploading' | 'success' | 'error';
  url?: string;
  error?: string;
}

interface ImageUploadStore {
  // çŠ¶æ€
  tasks: UploadTask[];
  isDragging: boolean;

  // æ“ä½œ
  addTask: (file: File) => string;
  updateTask: (id: string, updates: Partial<UploadTask>) => void;
  removeTask: (id: string) => void;
  setDragging: (isDragging: boolean) => void;

  // ä¸šåŠ¡æ–¹æ³•
  uploadFiles: (files: File[]) => Promise<string[]>;
  uploadSingle: (file: File) => Promise<string>;
  retryTask: (id: string) => Promise<void>;
}
```

---

## ğŸ¨ ç»„ä»¶è®¾è®¡

### ç»„ä»¶æ ‘

```
components/Editor/
â”œâ”€â”€ Dropzone/
â”‚   â”œâ”€â”€ index.tsx           # å¯¼å‡º
â”‚   â”œâ”€â”€ Dropzone.tsx        # æ‹–æ‹½åŒºåŸŸç»„ä»¶
â”‚   â”œâ”€â”€ DropOverlay.tsx     # æ‹–æ‹½æ—¶çš„é®ç½©å±‚
â”‚   â””â”€â”€ styles.css
â”œâ”€â”€ UploadManager/
â”‚   â”œâ”€â”€ index.tsx
â”‚   â”œâ”€â”€ UploadManager.tsx   # ä¸Šä¼ ç®¡ç†å™¨
â”‚   â”œâ”€â”€ ProgressBar.tsx     # è¿›åº¦æ¡
â”‚   â””â”€â”€ styles.css
â””â”€â”€ hooks/
    â””â”€â”€ useImageUpload.ts   # ä¸Šä¼ é€»è¾‘ Hook
```

### Dropzone ç»„ä»¶æ¥å£

```typescript
interface DropzoneProps {
  onUploadSuccess: (url: string, file: File) => void;
  onUploadError?: (error: Error, file: File) => void;
  disabled?: boolean;
  children: React.ReactNode;  // ç¼–è¾‘å™¨ç»„ä»¶
}

// ä½¿ç”¨ç¤ºä¾‹
<Dropzone onUploadSuccess={(url) => insertImage(url)}>
  <MarkdownEditor />
</Dropzone>
```

### UploadManager ç»„ä»¶æ¥å£

```typescript
interface UploadManagerProps {
  tasks: UploadTask[];
  onRetry: (id: string) => void;
  onCancel: (id: string) => void;
}
```

---

## ğŸ’¾ å­˜å‚¨è®¾è®¡

æ— éœ€æ–°å¢å­˜å‚¨ï¼Œä¸Šä¼ ä»»åŠ¡ä»…å­˜åœ¨äºå†…å­˜çŠ¶æ€ä¸­ã€‚

---

## ğŸ”Œ API è®¾è®¡

### useImageUpload Hook

```typescript
interface UseImageUploadOptions {
  onProgress?: (file: File, progress: number) => void;
  onSuccess?: (url: string, file: File) => void;
  onError?: (error: Error, file: File) => void;
}

interface UseImageUploadReturn {
  upload: (file: File) => Promise<string>;
  uploadMultiple: (files: File[]) => Promise<string[]>;
  isUploading: boolean;
  progress: Record<string, number>;
}

export function useImageUpload(
  options?: UseImageUploadOptions
): UseImageUploadReturn;
```

### ç°æœ‰å›¾åºŠæœåŠ¡é€‚é…

åˆ›å»ºç»Ÿä¸€çš„ä¸Šä¼ æ¥å£é€‚é…å™¨ï¼š

```typescript
// services/imageUpload/adapter.ts
interface ImageUploadAdapter {
  upload(file: File, onProgress?: (progress: number) => void): Promise<string>;
}

// é€‚é…ç°æœ‰å›¾åºŠæœåŠ¡
class LocalStorageAdapter implements ImageUploadAdapter { /* ... */ }
class R2WorkerAdapter implements ImageUploadAdapter { /* ... */ }
class QiniuAdapter implements ImageUploadAdapter { /* ... */ }
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- [ ] æ–‡ä»¶ç±»å‹éªŒè¯å‡½æ•°
- [ ] æ–‡ä»¶å¤§å°éªŒè¯å‡½æ•°
- [ ] UploadTask çŠ¶æ€è½¬æ¢é€»è¾‘

### é›†æˆæµ‹è¯•
- [ ] æ‹–æ‹½äº‹ä»¶å¤„ç†
- [ ] ç²˜è´´äº‹ä»¶å¤„ç†
- [ ] ä¸Šä¼ é˜Ÿåˆ—ç®¡ç†
- [ ] è¿›åº¦æ›´æ–°

### E2E æµ‹è¯•
- [ ] å®Œæ•´æ‹–æ‹½ä¸Šä¼ æµç¨‹
- [ ] å®Œæ•´ç²˜è´´ä¸Šä¼ æµç¨‹
- [ ] é”™è¯¯é‡è¯•æµç¨‹

---

## ğŸš€ å®æ–½è®¡åˆ’

### å¼€å‘ä»»åŠ¡

| ä»»åŠ¡ | è´Ÿè´£äºº | ä¾èµ– |
|------|--------|------|
| 1. åˆ›å»º imageUploadStore | @name | - |
| 2. å®ç° Dropzone ç»„ä»¶ | @name | 1 |
| 3. å®ç° useImageUpload Hook | @name | - |
| 4. åˆ›å»º UploadManager ç»„ä»¶ | @name | 1, 3 |
| 5. é€‚é…ç°æœ‰å›¾åºŠæœåŠ¡ | @name | 3 |
| 6. é›†æˆåˆ°ç¼–è¾‘å™¨ | @name | 2, 4, 5 |
| 7. ç¼–å†™æµ‹è¯• | @name | 6 |

### ä¾èµ–å…³ç³»
```
Store â†’ Hook â†’ ç»„ä»¶ â†’ é›†æˆ
  â†“        â†“       â†“
æµ‹è¯• â† â† â† â† â† â† â†
```

---

## âš ï¸ é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|------|------|----------|
| ç°æœ‰å›¾åºŠæœåŠ¡ä¸æ”¯æŒè¿›åº¦å›è°ƒ | æ— æ³•æ˜¾ç¤ºè¿›åº¦ | ä½¿ç”¨æ¨¡æ‹Ÿè¿›åº¦æˆ–æ˜¾ç¤º loading çŠ¶æ€ |
| å¤§æ–‡ä»¶ä¸Šä¼ é˜»å¡ UI | ç”¨æˆ·ä½“éªŒå·® | ä½¿ç”¨ Web Worker æˆ–åˆ†ç‰‡ä¸Šä¼  |
| ç²˜è´´äº‹ä»¶ä¸ç¼–è¾‘å™¨å†²çª | ç²˜è´´æ–‡å­—å¼‚å¸¸ | éœ€è¦æ™ºèƒ½åˆ¤æ–­å‰ªè´´æ¿å†…å®¹ç±»å‹ |

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [PRD æ–‡æ¡£](./prd.md)
- [UI è®¾è®¡](./ui-design.md)
- [HTML Drag and Drop API](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API)
- [Clipboard API](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API)
- [ç°æœ‰å›¾åºŠæœåŠ¡](apps/web/src/services/imageUpload/)

---

## ğŸ“ å˜æ›´è®°å½•

| æ—¥æœŸ | ç‰ˆæœ¬ | å˜æ›´å†…å®¹ | ä½œè€… |
|------|------|----------|------|
| 2024-01-13 | 1.0 | åˆå§‹ç‰ˆæœ¬ | @Claude |
